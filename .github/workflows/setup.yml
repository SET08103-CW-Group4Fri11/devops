name: A workflow for Devops App
on: push

jobs:
  Unit-Tests:
    name: Unit Tests
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      # Rely on Maven/JUnit discovery; pattern globs can be flaky across shells
      - name: Run Unit Tests
        run: mvn -B -q -DskipITs test

  Integration-Tests:
    name: Integration Tests
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # Provide DB_URL/DB_USER/DB_PASS to your app via .env for docker compose
      - name: Create .env from secrets
        run: |
          cat > .env <<EOF
          DB_URL=${{ secrets.DB_URL }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASS=${{ secrets.DB_PASS }}
          EOF
          echo "Created .env with DB variables."

      # Start only the db service defined in compose.yml
      - name: Start MySQL (compose)
        run: docker compose up -d db

      # Wait for MySQL to be ready (port open and accepting connections)
      - name: Wait for MySQL
        run: |
          echo "Waiting for MySQL to accept connections..."
          for i in {1..60}; do
            if docker compose logs db | grep -q "ready for connections"; then
              echo "MySQL ready."
              break
            fi
            sleep 2
          done

      # Run only integration tests (your package com.napier.integration)
      - name: Run Integration Tests
        env:
          DB_URL: ${{ secrets.DB_URL }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASS: ${{ secrets.DB_PASS }}
        run: mvn -B -q -Dtest='com.napier.integration.**' test

      - name: Show DB logs on failure
        if: failure()
        run: docker compose logs db

      - name: Stop MySQL
        if: always()
        run: docker compose down -v

  Build:
    name: Compose up and Logs
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      - name: Create .env from secrets
        run: |
          cat > .env <<EOF
          DB_URL=${{ secrets.DB_URL }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASS=${{ secrets.DB_PASS }}
          EOF
      - name: Build with Maven (skip tests)
        run: mvn -B -q clean package -DskipTests
      - name: Run docker compose (app + db)
        run: docker compose up --abort-on-container-exit
      - name: View app logs
        if: always()
        run: docker logs devops-container || true
      - name: Down
        if: always()
        run: docker compose down -v
